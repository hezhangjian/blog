<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hezhangjian.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12,"onmobile":false},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null,"show_result":false},"fold":{"enable":false,"height":500},"language":false,"highlight_theme":"normal"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="张俭的博客">
<meta property="og:url" content="https://hezhangjian.com/page/7/index.html">
<meta property="og:site_name" content="张俭的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zhangjian He">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hezhangjian.com/page/7/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>张俭的博客</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">张俭的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zhangjian He</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">128</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hezhangjian" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hezhangjian" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://x.com/hezhangjian" title="Twitter → https:&#x2F;&#x2F;x.com&#x2F;hezhangjian" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hezhangjian.com/2021/11/02/%E4%BC%98%E7%A7%80%E5%AE%9E%E8%B7%B5%E4%B9%8B%E7%94%A8%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%B5%8B%E8%AF%95%E4%B8%8B%E5%B1%82%E4%BE%9D%E8%B5%96%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhangjian He">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张俭的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 张俭的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/02/%E4%BC%98%E7%A7%80%E5%AE%9E%E8%B7%B5%E4%B9%8B%E7%94%A8%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%B5%8B%E8%AF%95%E4%B8%8B%E5%B1%82%E4%BE%9D%E8%B5%96%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC/" class="post-title-link" itemprop="url">优秀实践之用单元测试测试下层依赖的默认值</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-02 13:10:44" itemprop="dateCreated datePublished" datetime="2021-11-02T13:10:44+08:00">2021-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-21 19:32:27" itemprop="dateModified" datetime="2025-10-21T19:32:27+08:00">2025-10-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>这些天，在给项目<strong>servicecomb</strong>提交代码，升级其中的<code>vertx</code>和<code>netty</code>版本号，发现有单元测试用例跑不过</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/servicecomb-java-chassis/pull/2614">https://github.com/apache/servicecomb-java-chassis/pull/2614</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetMaxFormAttributeSize</span><span class="params">()</span> &#123;</span><br><span class="line">  Assert.assertEquals(<span class="number">8192</span>, TransportConfig.getMaxFormAttributeSize());</span><br><span class="line">  ArchaiusUtils.setProperty(<span class="string">&quot;servicecomb.rest.server.maxFormAttributeSize&quot;</span>, <span class="number">3072</span>);</span><br><span class="line">  Assert.assertEquals(<span class="number">3072</span>, TransportConfig.getMaxFormAttributeSize());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这个用例可以拦截，如果新版本<strong>TransportConfig</strong>中依赖的底层默认值修改为非8192的问题。</p>
<p>对于底层依赖的其他项目，有些参数有统一的文件放置，甚至有些项目，参数分散在各个文件。相比升级后，逐个参数检查，通过单元测试能更有效的发现默认值的变化或移动再处理。我觉得这是一个很好的实践。推广到非library库中，我们维护的pulsar、mysql等组件，也可以通过ut测试来保证一些配置文件中的默认参数没有新增、删除或修改。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hezhangjian.com/2021/10/31/%E8%87%AA%E4%B8%8A%E8%80%8C%E4%B8%8B%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BE%E8%AE%A1%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhangjian He">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张俭的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 张俭的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/31/%E8%87%AA%E4%B8%8A%E8%80%8C%E4%B8%8B%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BE%E8%AE%A1%EF%BC%88%E4%B8%80%EF%BC%89/" class="post-title-link" itemprop="url">自上而下的安全设计（一）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-31 16:11:00" itemprop="dateCreated datePublished" datetime="2021-10-31T16:11:00+08:00">2021-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-21 19:32:27" itemprop="dateModified" datetime="2025-10-21T19:32:27+08:00">2025-10-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>这是近期观摩某个产品安全加固时的心得，也请教过我们部门的安全专家、架构师。第一篇文章，我想先分析一下重要性和我心中的实现原则。后面可以贴出一些更详细的流程和代码样例</p>
<h2 id="早期没有做好安全，后果很严重"><a href="#早期没有做好安全，后果很严重" class="headerlink" title="早期没有做好安全，后果很严重"></a>早期没有做好安全，后果很严重</h2><p>李林峰老师，也就是《Netty权威指南》的作者，同样也在华为工作 :)<br>。在一本书就曾写过，见过很多产品在安全审核上投入了大量的时间和精力。我表示深深地认同。而这些，往往是因为产品在初期没有做好好的安全设计。以一个假想产品举例，</p>
<p><img src="/Images/security-design.png" alt="image-20211031152752639"></p>
<p>图中，A与B之间，A与配置中心之前，都存在放置敏感信息的可能。有意思的事情来了，当安全分析发现了A与B之前存在放置敏感信息的可能时，产品决定把A与Mysql之间的通信进行加密和认证，加密的源材料放在哪？决策放到配置中心。可是，当安全分析发现A与配置中心之间存在传递敏感信息的可能时？那产品又应该怎么做？总不能放在Mysql这里吧。</p>
<p>由此可见，如果没有一个完善的从上而下的安全设计，产品在搞安全增强或者说加固的时候，就像哪里破了刷哪里一样，把房间弄得乱七八糟，事倍功半。我相信更难受的是那些刷墙的开发人员。</p>
<h2 id="自上而下安全设计的核心"><a href="#自上而下安全设计的核心" class="headerlink" title="自上而下安全设计的核心"></a>自上而下安全设计的核心</h2><p>作为一个开发人员，我还是站在开发人员的角度。我认为对于开发人员的核心就是有一个 证书可轮换、密钥可轮换的基础机制。毕竟开发人员最常碰到的安全问题就是：</p>
<ul>
<li>通信中敏感数据没有加密</li>
<li>通信中双方没有做认证</li>
<li>敏感信息存储没有加密</li>
</ul>
<p>拥有了证书可轮换、密钥可轮换的机制，开发人员就可以轻而易举地搞定这三件事情。</p>
<h3 id="从设计、开发人员的思维、底层库开始，证书、密钥都是支持可替换的"><a href="#从设计、开发人员的思维、底层库开始，证书、密钥都是支持可替换的" class="headerlink" title="从设计、开发人员的思维、底层库开始，证书、密钥都是支持可替换的"></a>从设计、开发人员的思维、底层库开始，证书、密钥都是支持可替换的</h3><ul>
<li>底层库支持证书轮换、密钥轮换，同时注意轮换时老密钥的存留时间等</li>
<li>密钥更新时，如果需要彻底废弃老密钥，注意旧数据需要重新解密后用新密钥加密</li>
<li>开发人员也要认同密钥是可替换的，甚至不同用户的密钥可以是不一样的，不然如果平时测试覆盖不到密钥替换，真正实施的话，就会不敢实施，或者出现现网事故</li>
</ul>
<h3 id="证书、密钥的存储"><a href="#证书、密钥的存储" class="headerlink" title="证书、密钥的存储"></a>证书、密钥的存储</h3><p>往往，我们开发的任意两个组件之间，都可能会要求互相通信和认证，更不用提那些初始口令了，肯定是需要加密的，所以证书和密钥不适合存在产品自己开发的配置中心，或者是数据库中。更适合在安装部署阶段放置在更底层，更基础设施中，例如</p>
<ul>
<li>专用的加密硬件</li>
<li>依赖公有云进行部署的，可以将证书存放在云上托管的Kubernetes集群的secret中，并对k8s集群进行加固，避免根密钥、根证书泄露</li>
</ul>
<p>这些都可以由部署工具自动导入或人工手动导入。</p>
<h3 id="设计证书、密钥的使用轮换机制"><a href="#设计证书、密钥的使用轮换机制" class="headerlink" title="设计证书、密钥的使用轮换机制"></a>设计证书、密钥的使用轮换机制</h3><ul>
<li>证书的粒度：是每个微服务一个证书还是每个业务场景一个证书</li>
<li>密钥的粒度：是每个客户一个工作密钥还是共享一个工作密钥</li>
<li>轮换时是否容忍业务损失，最大可损失时长是多久</li>
<li>还要注意每个微服务能获取到的证书和密钥，它只应该获取它需要的证书、密钥，理论上单一微服务不应该有获取根证书、根密钥的能力。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hezhangjian.com/2021/10/20/Cassandra%E4%B8%AD%E7%9A%84Primary%20Key%E3%80%81Partition%20Key%E3%80%81Clustering%20Key%E9%83%BD%E6%98%AF%E4%BB%80%E4%B9%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhangjian He">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张俭的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 张俭的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/20/Cassandra%E4%B8%AD%E7%9A%84Primary%20Key%E3%80%81Partition%20Key%E3%80%81Clustering%20Key%E9%83%BD%E6%98%AF%E4%BB%80%E4%B9%88/" class="post-title-link" itemprop="url">Cassandra中的Primary Key、Partition Key、Clustering Key都是什么？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-20 20:36:27" itemprop="dateCreated datePublished" datetime="2021-10-20T20:36:27+08:00">2021-10-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-21 19:32:27" itemprop="dateModified" datetime="2025-10-21T19:32:27+08:00">2025-10-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Cassandra中的Key有如下三种类型</p>
<ul>
<li>Primary Key</li>
<li>Partitioning Key</li>
<li>Clustering Key</li>
</ul>
<h2 id="Primary-Key-主键"><a href="#Primary-Key-主键" class="headerlink" title="Primary Key 主键"></a>Primary Key 主键</h2><p>每张表都需要有主键。主键可以是一个字段或者多个字段的组合。每条记录的主键必须唯一。举个例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE player (</span><br><span class="line">   name text,</span><br><span class="line">   club text,</span><br><span class="line">   league text,</span><br><span class="line">   nationality text,</span><br><span class="line">	 kit_number text,</span><br><span class="line">   position text,</span><br><span class="line">	 goals int,</span><br><span class="line">   assists int,</span><br><span class="line">   appearences int,</span><br><span class="line">   PRIMARY KEY (club, league, name, kit_number, position, goals)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这个数据表的主键有多个字段，称做复合主键。</p>
<h2 id="分区键"><a href="#分区键" class="headerlink" title="分区键"></a>分区键</h2><p><code>Cassandra</code>根据分区键，使用一致性哈希算法，把数据分配到集群的各个机器上。一个机器可以包含多个分区。<code>Cassandra</code>保证同一分区键的数据都在一台机器上。通过合理的设置分区键，可以让你的查询让尽量少的机器处理，提升查询的效率</p>
<p>对于单主键字段来说，分区键和主键是同一个字段。</p>
<p>对于复合主键字段来说，默认情况下，分区键是复合主键的第一个字段。如上例中，分区键是<code>club</code>字段</p>
<p>可以通过括号来将分区键指定为多个字段，如将上面<code>CQL</code>的11行修改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRIMARY KEY ((name, club), league, kit_number, position, goals)</span><br></pre></td></tr></table></figure>

<h2 id="Clustering-Key"><a href="#Clustering-Key" class="headerlink" title="Clustering Key"></a>Clustering Key</h2><p>Clustering Keys决定了分区内数据的排序。让我们再看一下最初的例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE player (</span><br><span class="line">   name text,</span><br><span class="line">   club text,</span><br><span class="line">   league text,</span><br><span class="line">   nationality text,</span><br><span class="line">	 kit_number text,</span><br><span class="line">   position text,</span><br><span class="line">	 goals int,</span><br><span class="line">   assists int,</span><br><span class="line">   appearences int,</span><br><span class="line">   PRIMARY KEY (club, league, name, kit_number, position, goals)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>在主键中的字段，除了分区键外都是<strong>clustering key</strong>。既然<code>club</code>是主键，那么<code>league name kit_number position goals</code>是Clustering key。你可以定义<strong>clustering key</strong>中每个字段的升降序。可以将<code>kit_number</code>降序、<code>goals</code>升序</p>
<p>排序顺序与主键中字段的顺序相同。因此，在上面的例子中，数据是按照如下布局的</p>
<ul>
<li>所有相同<code>club</code>的运动员都将分在同一个分区</li>
<li>在分区内，按照<code>leauge</code>排序</li>
<li>然后按照<code>name</code>排序</li>
<li>然后按照<code>kit_number</code>排序</li>
<li>…</li>
</ul>
<p>定义不同字段升降序的语法如下(默认为升序)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE player (</span><br><span class="line">   name text,</span><br><span class="line">   club text,</span><br><span class="line">   league text,</span><br><span class="line">   nationality text,</span><br><span class="line">	 kit_number text,</span><br><span class="line">   position text,</span><br><span class="line">	 goals int,</span><br><span class="line">   assists int,</span><br><span class="line">   appearances int,</span><br><span class="line">   PRIMARY KEY (club, league, name, kit_number, position, goals)</span><br><span class="line">)</span><br><span class="line">WITH CLUSTERING ORDER BY (league ASC, name DESC, kit_number ASC, position DESC );</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hezhangjian.com/2021/10/17/valgrind%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%A3%80%E6%B5%8B%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhangjian He">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张俭的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 张俭的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/17/valgrind%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%A3%80%E6%B5%8B%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/" class="post-title-link" itemprop="url">Valgrind内存泄漏检测快速上手</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-17 16:13:57" itemprop="dateCreated datePublished" datetime="2021-10-17T16:13:57+08:00">2021-10-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-21 19:32:27" itemprop="dateModified" datetime="2025-10-21T19:32:27+08:00">2025-10-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="准备被测程序"><a href="#准备被测程序" class="headerlink" title="准备被测程序"></a>准备被测程序</h2><p>通过<code>-g</code>编译程序来携带debug信息，这样子输出的错误信息就可以包含精确的行号。如果你可以承受程序运行缓慢，那么我们可以使用<code>-O0</code>来编译程序。如果使用<code>-O1</code>，那么输出的行号可能会不准确。不推荐使用<code>-O2</code>及以上，因为 <code>valgrind memcheck</code> 偶尔会报告不存在的未初始化值错误。</p>
<h2 id="运行程序"><a href="#运行程序" class="headerlink" title="运行程序"></a>运行程序</h2><p>如果平时这么运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myprog arg1 arg2</span><br></pre></td></tr></table></figure>

<p>就使用这个命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valgrind --leak-check=<span class="built_in">yes</span> myprog arg1 arg2</span><br></pre></td></tr></table></figure>

<p><code>Memcheck</code>是默认的<code>valgrind</code>工具，<code>--leak-check</code>打开了内存泄漏检测开关。</p>
<p>通过这个命令运行，大约会比平时运行慢20到30倍，并且使用更大的内存。Memcheck 将发出它检测到的内存错误和泄漏的信息。</p>
<h2 id="解释memcheck的输出"><a href="#解释memcheck的输出" class="headerlink" title="解释memcheck的输出"></a>解释<code>memcheck</code>的输出</h2><p>使用样例的C程序，包含一个内存分配错误和内存溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">f</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">int</span>* x = <span class="built_in">malloc</span>(<span class="number">10</span> * <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">   x[<span class="number">10</span>] = <span class="number">0</span>;        <span class="comment">// problem 1: heap block overrun</span></span><br><span class="line">&#125;                    <span class="comment">// problem 2: memory leak -- x not freed</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">   f();</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行内存检测</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -g demo.c</span><br><span class="line">valgrind ./a.out</span><br></pre></td></tr></table></figure>

<p>输出信息如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">==145== Memcheck, a memory error detector</span><br><span class="line">==145== Copyright (C) 2002-2017, and GNU GPL&#x27;d, by Julian Seward et al.</span><br><span class="line">==145== Using Valgrind-3.17.0 and LibVEX; rerun with -h for copyright info</span><br><span class="line">==145== Command: ./a.out</span><br><span class="line">==145==</span><br><span class="line">==145== Invalid write of size 4</span><br><span class="line">==145==    at 0x401144: f (demo.c:6)</span><br><span class="line">==145==    by 0x401155: main (demo.c:11)</span><br><span class="line">==145==  Address 0x4a27068 is 0 bytes after a block of size 40 alloc&#x27;d</span><br><span class="line">==145==    at 0x484086F: malloc (vg_replace_malloc.c:380)</span><br><span class="line">==145==    by 0x401137: f (demo.c:5)</span><br><span class="line">==145==    by 0x401155: main (demo.c:11)</span><br><span class="line">==145==</span><br><span class="line">==145==</span><br><span class="line">==145== HEAP SUMMARY:</span><br><span class="line">==145==     in use at exit: 40 bytes in 1 blocks</span><br><span class="line">==145==   total heap usage: 1 allocs, 0 frees, 40 bytes allocated</span><br><span class="line">==145==</span><br><span class="line">==145== 40 bytes in 1 blocks are definitely lost in loss record 1 of 1</span><br><span class="line">==145==    at 0x484086F: malloc (vg_replace_malloc.c:380)</span><br><span class="line">==145==    by 0x401137: f (demo.c:5)</span><br><span class="line">==145==    by 0x401155: main (demo.c:11)</span><br><span class="line">==145==</span><br><span class="line">==145== LEAK SUMMARY:</span><br><span class="line">==145==    definitely lost: 40 bytes in 1 blocks</span><br><span class="line">==145==    indirectly lost: 0 bytes in 0 blocks</span><br><span class="line">==145==      possibly lost: 0 bytes in 0 blocks</span><br><span class="line">==145==    still reachable: 0 bytes in 0 blocks</span><br><span class="line">==145==         suppressed: 0 bytes in 0 blocks</span><br><span class="line">==145==</span><br><span class="line">==145== For lists of detected and suppressed errors, rerun with: -s</span><br><span class="line">==145== ERROR SUMMARY: 2 errors from 2 contexts (suppressed: 0 from 0)</span><br></pre></td></tr></table></figure>

<ul>
<li>145 是进程号</li>
<li>输出的第一行，即上方的第六行(<code>Invalid write</code>)表明了错误的类型。这里程序往不归它拥有的内存中写入了信息</li>
<li>下方是错误的堆栈信息</li>
<li>代码地址如<code>0x401155</code>通常并不重要，但有时候定位奇怪的问题可能会很关键</li>
<li>一些错误信息会有第二段，用来描述所涉及的内存地址。上例指出写入的内存刚好超过 example.c 的第 5 行使用 malloc() 分配的块的末尾。</li>
</ul>
<h3 id="内存泄漏信息"><a href="#内存泄漏信息" class="headerlink" title="内存泄漏信息"></a>内存泄漏信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">==145== 40 bytes in 1 blocks are definitely lost in loss record 1 of 1</span><br><span class="line">==145==    at 0x484086F: malloc (vg_replace_malloc.c:380)</span><br><span class="line">==145==    by 0x401137: f (demo.c:5)</span><br><span class="line">==145==    by 0x401155: main (demo.c:11)</span><br></pre></td></tr></table></figure>

<p>堆栈可以表明什么内存泄露了，但<code>memcheck</code>并不能告诉你内存泄漏的原因</p>
<p>valgrind会提示两种内存泄漏</p>
<ul>
<li>“definitely lost”: 绝对泄漏了内存，必须修复</li>
<li>“probably lost”:  程序可能泄漏了内存，也有可能是一些特定的指针操作（如：指针放到了堆中）</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.valgrind.org/docs/manual/quick-start.html#quick-start.intro">https://www.valgrind.org/docs/manual/quick-start.html#quick-start.intro</a></p>
<p><a target="_blank" rel="noopener" href="https://www.valgrind.org/docs/manual/mc-manual.html#mc-manual.errormsgs">https://www.valgrind.org/docs/manual/mc-manual.html#mc-manual.errormsgs</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hezhangjian.com/2021/10/16/MySQL%E7%94%9F%E6%88%90%20core%20dump%E6%96%87%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhangjian He">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张俭的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 张俭的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/16/MySQL%E7%94%9F%E6%88%90%20core%20dump%E6%96%87%E4%BB%B6/" class="post-title-link" itemprop="url">MySQL生成 core dump文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-16 23:32:43" itemprop="dateCreated datePublished" datetime="2021-10-16T23:32:43+08:00">2021-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-21 19:32:27" itemprop="dateModified" datetime="2025-10-21T19:32:27+08:00">2025-10-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><h2 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a>添加配置</h2><h3 id="mysqld-下面添加core-file"><a href="#mysqld-下面添加core-file" class="headerlink" title="[mysqld]下面添加core-file"></a>[mysqld]下面添加<code>core-file</code></h3><p><img src="/Images/mysql-core-dump1.png" alt="image-20211016232603862"></p>
<h3 id="ulimit打开core-file限制"><a href="#ulimit打开core-file限制" class="headerlink" title="ulimit打开core file限制"></a>ulimit打开core file限制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -c unlimited</span><br></pre></td></tr></table></figure>

<h3 id="如需要，修改core-file路径（如在容器内，需要特权容器权限）"><a href="#如需要，修改core-file路径（如在容器内，需要特权容器权限）" class="headerlink" title="如需要，修改core file路径（如在容器内，需要特权容器权限）"></a>如需要，修改core file路径（如在容器内，需要特权容器权限）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/opt/sh/mysql/core/core&quot;</span> &gt; /proc/sys/kernel/core_pattern</span><br></pre></td></tr></table></figure>

<h3 id="使得core-file携带pid信息"><a href="#使得core-file携带pid信息" class="headerlink" title="使得core file携带pid信息"></a>使得core file携带pid信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt;/proc/sys/kernel/core_uses_pid</span><br></pre></td></tr></table></figure>

<h2 id="通过kill命令获取core-file"><a href="#通过kill命令获取core-file" class="headerlink" title="通过kill命令获取core file"></a>通过kill命令获取core file</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -11 <span class="variable">$pid</span></span><br></pre></td></tr></table></figure>

<p><img src="/Images/mysql-core-dump2.png" alt="image-20211016233105059"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hezhangjian.com/2021/09/29/%E4%BD%BF%E7%94%A8arthas%E7%94%9F%E6%88%90java%E7%A8%8B%E5%BA%8Fcpu%E7%81%AB%E7%84%B0%E5%9B%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhangjian He">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张俭的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 张俭的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/29/%E4%BD%BF%E7%94%A8arthas%E7%94%9F%E6%88%90java%E7%A8%8B%E5%BA%8Fcpu%E7%81%AB%E7%84%B0%E5%9B%BE/" class="post-title-link" itemprop="url">使用arthas生成java程序cpu火焰图</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-29 15:15:28" itemprop="dateCreated datePublished" datetime="2021-09-29T15:15:28+08:00">2021-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-21 19:32:27" itemprop="dateModified" datetime="2025-10-21T19:32:27+08:00">2025-10-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>需要有一个运行的java程序，如果你已经有了运行中的java程序，请跳过这一节，示例，我启动自制的kafka镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run ttbb/kafka:mate</span><br></pre></td></tr></table></figure>

<h3 id="找到java程序的pid"><a href="#找到java程序的pid" class="headerlink" title="找到java程序的pid"></a>找到java程序的pid</h3><p><code>ps -ef</code>或者<code>jps</code>均可，其中<code>jps</code>需要安装jdk</p>
<p><img src="/Images/arthas-flame-graph1.png" alt="image-20210929143232887"></p>
<h3 id="安装arthas"><a href="#安装arthas" class="headerlink" title="安装arthas"></a>安装arthas</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/alibaba/arthas/releases/download/arthas-all-3.5.4/arthas-bin.zip</span><br><span class="line"><span class="built_in">mkdir</span> -p arthas</span><br><span class="line">unzip arthas-bin.zip -d arthas</span><br></pre></td></tr></table></figure>

<h3 id="使用arthas连接到目标程序"><a href="#使用arthas连接到目标程序" class="headerlink" title="使用arthas连接到目标程序"></a>使用arthas连接到目标程序</h3><p><img src="/Images/arthas-flame-graph2.png" alt="image-20210929143537663"></p>
<h3 id="开始profiler"><a href="#开始profiler" class="headerlink" title="开始profiler"></a>开始profiler</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">profiler start</span><br></pre></td></tr></table></figure>

<p>如果出现<code>Perf events unavailable. See stderr of the target process.</code>如图所示</p>
<p><img src="/Images/arthas-flame-graph3.png" alt="image-20210929143621015"></p>
<p>需要在docker所在虚拟机上执行如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/perf_event_paranoid</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/kptr_restrict</span><br></pre></td></tr></table></figure>

<p>如果是mac用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --privileged --pid=host debian nsenter -t 1 -m -u -n -i sh</span><br></pre></td></tr></table></figure>

<p>执行上述命令进入docker所在的虚拟机操作即可</p>
<p>注意，在部分docker版本中，有可能还无法进行profiler采集，您可能需要以特权方式启动容器，不过，为了定位性能问题，这总是值得付出的，不是吗？</p>
<p><img src="/Images/arthas-flame-graph4.png" alt="image-20210929151106090"></p>
<h3 id="等待profiler一段时间"><a href="#等待profiler一段时间" class="headerlink" title="等待profiler一段时间"></a>等待profiler一段时间</h3><p>一般等待一分钟即可</p>
<h3 id="结束profiler"><a href="#结束profiler" class="headerlink" title="结束profiler"></a>结束profiler</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">profiler stop</span><br></pre></td></tr></table></figure>

<p><img src="/Images/arthas-flame-graph5.png" alt="image-20210929151209352"></p>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><p>Congratulations，完成了火焰图的输出，现在你可以使用火焰图来分析执行时间较长的方法啦</p>
<p><img src="/Images/arthas-flame-graph6.png" alt="image-20210929151506122"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hezhangjian.com/2021/08/28/OpenKruise%E7%94%A8%E5%88%B0%E7%9A%84%E6%8A%80%E6%9C%AF%20%E7%BD%91%E7%BB%9C%E7%9B%91%E5%90%AC%E5%8F%A5%E6%9F%84%E5%8A%A8%E6%80%81%E8%BD%AC%E7%A7%BB%20%E5%88%87%E6%8D%A2%E7%BD%91%E7%BB%9C%E7%9B%91%E5%90%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhangjian He">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张俭的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 张俭的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/28/OpenKruise%E7%94%A8%E5%88%B0%E7%9A%84%E6%8A%80%E6%9C%AF%20%E7%BD%91%E7%BB%9C%E7%9B%91%E5%90%AC%E5%8F%A5%E6%9F%84%E5%8A%A8%E6%80%81%E8%BD%AC%E7%A7%BB%20%E5%88%87%E6%8D%A2%E7%BD%91%E7%BB%9C%E7%9B%91%E5%90%AC/" class="post-title-link" itemprop="url">OpenKruise用到的技术 网络监听句柄动态转移 切换网络监听</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-28 20:04:58" itemprop="dateCreated datePublished" datetime="2021-08-28T20:04:58+08:00">2021-08-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-21 19:32:27" itemprop="dateModified" datetime="2025-10-21T19:32:27+08:00">2025-10-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>今天看到了<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/tTipcU8MKxTpFurWNEUIww">https://mp.weixin.qq.com/s/tTipcU8MKxTpFurWNEUIww</a> 中热迁移网络句柄的功能，忍不住自己在机器上实验了一下，确实可以实现网络句柄的迁移。实验代码如下</p>
<h2 id="old-server"><a href="#old-server" class="headerlink" title="old_server"></a>old_server</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line">	<span class="string">&quot;syscall&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	tcpAddr := net.TCPAddr&#123;Port: <span class="number">8001</span>&#125;</span><br><span class="line">	tcpLn, err := net.ListenTCP(<span class="string">&quot;tcp4&quot;</span>, &amp;tcpAddr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	f, _ := tcpLn.File()</span><br><span class="line">	fdNum := f.Fd()</span><br><span class="line">	data := syscall.UnixRights(<span class="type">int</span>(fdNum))</span><br><span class="line">	<span class="comment">// 与新版本sidecar通过Unix Domain Socket建立链接</span></span><br><span class="line">	raddr, _ := net.ResolveUnixAddr(<span class="string">&quot;unix&quot;</span>, <span class="string">&quot;/dev/shm/migrate.sock&quot;</span>)</span><br><span class="line">	uds, _ := net.DialUnix(<span class="string">&quot;unix&quot;</span>, <span class="literal">nil</span>, raddr)</span><br><span class="line">	<span class="comment">// 通过UDS，发送ListenFD到新版本sidecar容器</span></span><br><span class="line">	_, _, _ = uds.WriteMsgUnix(<span class="literal">nil</span>, data, <span class="literal">nil</span>)</span><br><span class="line">	<span class="comment">// 停止接收新的request，并且开始排水阶段</span></span><br><span class="line">	tcpLn.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="new-server"><a href="#new-server" class="headerlink" title="new_server"></a>new_server</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;syscall&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 新版本sidecar 接收ListenFD，并且开始对外服务</span></span><br><span class="line">	<span class="comment">// 监听UDS</span></span><br><span class="line">	addr, _ := net.ResolveUnixAddr(<span class="string">&quot;unix&quot;</span>, <span class="string">&quot;/dev/shm/migrate.sock&quot;</span>)</span><br><span class="line">	unixLn, _ := net.ListenUnix(<span class="string">&quot;unix&quot;</span>, addr)</span><br><span class="line">	conn, _ := unixLn.AcceptUnix()</span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">32</span>)</span><br><span class="line">	oob := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">32</span>)</span><br><span class="line">	time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">	<span class="comment">// 接收 ListenFD</span></span><br><span class="line">	_, oobn, _, _, _ := conn.ReadMsgUnix(buf, oob)</span><br><span class="line">	scms, _ := syscall.ParseSocketControlMessage(oob[:oobn])</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(scms) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// 解析FD，并转化为 *net.TCPListener</span></span><br><span class="line">		fds, _ := syscall.ParseUnixRights(&amp;scms[<span class="number">0</span>])</span><br><span class="line">		f := os.NewFile(<span class="type">uintptr</span>(fds[<span class="number">0</span>]), <span class="string">&quot;&quot;</span>)</span><br><span class="line">		ln, _ := net.FileListener(f)</span><br><span class="line">		tcpLn, _ := ln.(*net.TCPListener)</span><br><span class="line">		http.Serve(tcpLn, &amp;MyHttp&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyHttp <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*MyHttp)</span></span> ServeHTTP(w http.ResponseWriter, req *http.Request) &#123;</span><br><span class="line">	fmt.Fprintf(w, <span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h2><ul>
<li>先启动new_server</li>
<li>再启动old_server</li>
<li>然后访问<code>localhost:8001</code>，返回<code>hello world</code>，这是<code>new_server</code>返回的结果</li>
</ul>
<h2 id="代码地址"><a href="#代码地址" class="headerlink" title="代码地址"></a>代码地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/hezhangjian/go_demo/tree/main/demo_base/fd_migrate">https://github.com/hezhangjian/go_demo/tree/main/demo_base/fd_migrate</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hezhangjian.com/2021/08/28/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%97%A0%E5%8D%95%E7%82%B9%E6%9E%B6%E6%9E%84%E4%B9%8B%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhangjian He">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张俭的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 张俭的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/kubernetes-registry-ha" class="post-title-link post-title-link-external" itemprop="url">高可用无单点架构之镜像仓库<i class="fa fa-external-link-alt"></i></a>
          
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-28 18:30:18" itemprop="dateCreated datePublished" datetime="2021-08-28T18:30:18+08:00">2021-08-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-21 19:32:27" itemprop="dateModified" datetime="2025-10-21T19:32:27+08:00">2025-10-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本篇文章探讨镜像仓库<code>registry</code>的高可用</p>
<h1 id="镜像仓库高可用无单点故障涉及那些场景"><a href="#镜像仓库高可用无单点故障涉及那些场景" class="headerlink" title="镜像仓库高可用无单点故障涉及那些场景"></a>镜像仓库高可用无单点故障涉及那些场景</h1><h2 id="镜像仓库对外提供访问无单点故障"><a href="#镜像仓库对外提供访问无单点故障" class="headerlink" title="镜像仓库对外提供访问无单点故障"></a>镜像仓库对外提供访问无单点故障</h2><p>镜像仓库对外提供的访问点保持高可用</p>
<h2 id="镜像仓库的数据存储高可用"><a href="#镜像仓库的数据存储高可用" class="headerlink" title="镜像仓库的数据存储高可用"></a>镜像仓库的数据存储高可用</h2><p>存储在镜像仓库中的数据都得是高可用的</p>
<h1 id="镜像仓库无单点故障技术关键点"><a href="#镜像仓库无单点故障技术关键点" class="headerlink" title="镜像仓库无单点故障技术关键点"></a>镜像仓库无单点故障技术关键点</h1><h2 id="镜像仓库对外提供访问无单点故障-1"><a href="#镜像仓库对外提供访问无单点故障-1" class="headerlink" title="镜像仓库对外提供访问无单点故障"></a>镜像仓库对外提供访问无单点故障</h2><p>和上一篇文章一样，如果<code>IaaS</code>能提供<code>ELB</code>，我们最好是使用<code>ELB</code>，或者使用浮动IP的方式替换</p>
<h2 id="镜像仓库的数据存储高可用-1"><a href="#镜像仓库的数据存储高可用-1" class="headerlink" title="镜像仓库的数据存储高可用"></a>镜像仓库的数据存储高可用</h2><ul>
<li>配置镜像仓库使用<code>IaaS</code>的S3存储</li>
<li>配置镜像仓库使用本地存储，通过共享文件路径存储来实现高可用，如<code>Glusterfs</code>等</li>
<li>配置镜像仓库使用S3存储，自建兼容S3 API的存储<code>Server</code></li>
</ul>
<p>通常会使用共享存储来做到镜像仓库存储的高可用</p>
<h1 id="方案概述"><a href="#方案概述" class="headerlink" title="方案概述"></a>方案概述</h1><p>那么其实镜像仓库的高可用方案就是对上面方案的组合，下面我们举几个例子</p>
<h2 id="镜像仓库依赖组件部署方式"><a href="#镜像仓库依赖组件部署方式" class="headerlink" title="镜像仓库依赖组件部署方式"></a>镜像仓库依赖组件部署方式</h2><p><code>MinIo</code>、<code>KeepAlived</code>、<code>registry</code>都推荐使用容器部署，方便运维管理，但是镜像推荐内置到虚拟机中，不依赖镜像仓库或其他组件，避免循环依赖</p>
<h2 id="使用IaaS的S3存储-负载均衡组件"><a href="#使用IaaS的S3存储-负载均衡组件" class="headerlink" title="使用IaaS的S3存储 + 负载均衡组件"></a>使用IaaS的S3存储 + 负载均衡组件</h2><p>这是最简单的方案，得益于云厂商提供的S3存储和负载均衡组件，我们可以进行很简单的配置，并部署一台以上的<code>registry</code>,如下图所示</p>
<p><img src="/Images/kubernetes-registry-ha-s3.png" alt="kubernetes-registry-ha-s3"></p>
<h2 id="自建兼容S3存储-KeepAlived浮动Ip"><a href="#自建兼容S3存储-KeepAlived浮动Ip" class="headerlink" title="自建兼容S3存储 + KeepAlived浮动Ip"></a>自建兼容S3存储 + KeepAlived浮动Ip</h2><p>我们可以自己搭建<code>MinIo</code>集群来作为兼容S3存储，由于MINIO最低部署4个节点，我们需要根据故障域机器来选择部署MINIO的数目，比如，故障域是三台物理机，我们部署4节点就不妥。原因是，4节点，总会有一台物理机上会部署2个minio节点，如果这台物理机挂掉，就会导致单点故障。所以，如果故障域为三台物理机，我们最好部署6节点，可容忍一台物理机宕机。其他的节点，读者也可以自行测算。</p>
<p>下图是假设三台物理机，<code>minio</code>6副本场景下的部署示意图</p>
<p><img src="/Images/kubernetes-registry-ha-minio.png" alt="kubernetes-registry-ha-minio"></p>
<p>注，为了图的美观，并未画出所有的连线</p>
<h3 id="MINIO关键配置"><a href="#MINIO关键配置" class="headerlink" title="MINIO关键配置"></a>MINIO关键配置</h3><ul>
<li>节点数目6个</li>
<li>EC2</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hezhangjian.com/2021/08/28/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%97%A0%E5%8D%95%E7%82%B9%E6%9E%B6%E6%9E%84%E4%B9%8Bkubernetes%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhangjian He">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张俭的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 张俭的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/kubernetes-ha" class="post-title-link post-title-link-external" itemprop="url">高可用无单点架构之kubernetes集群<i class="fa fa-external-link-alt"></i></a>
          
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-28 08:20:33" itemprop="dateCreated datePublished" datetime="2021-08-28T08:20:33+08:00">2021-08-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-21 19:32:27" itemprop="dateModified" datetime="2025-10-21T19:32:27+08:00">2025-10-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="k8s高可用无单点故障涉及那些场景"><a href="#k8s高可用无单点故障涉及那些场景" class="headerlink" title="k8s高可用无单点故障涉及那些场景"></a>k8s高可用无单点故障涉及那些场景</h1><h2 id="k8s-节点添加、pod添加等增删查改无单点故障"><a href="#k8s-节点添加、pod添加等增删查改无单点故障" class="headerlink" title="k8s 节点添加、pod添加等增删查改无单点故障"></a>k8s 节点添加、pod添加等增删查改无单点故障</h2><p>需要元数据的存储和处理能力高可用</p>
<h2 id="k8s对外的apiServer（如worker）无单点故障"><a href="#k8s对外的apiServer（如worker）无单点故障" class="headerlink" title="k8s对外的apiServer（如worker）无单点故障"></a>k8s对外的apiServer（如worker）无单点故障</h2><p>worker node和其他组件访问<code>apiServer</code>路径高可用</p>
<h1 id="k8s无单点故障技术关键点"><a href="#k8s无单点故障技术关键点" class="headerlink" title="k8s无单点故障技术关键点"></a>k8s无单点故障技术关键点</h1><h2 id="元数据存储"><a href="#元数据存储" class="headerlink" title="元数据存储"></a>元数据存储</h2><p>通过etcd存储元数据，etcd三节点集群保证高可用</p>
<h2 id="元数据处理"><a href="#元数据处理" class="headerlink" title="元数据处理"></a>元数据处理</h2><p>通过多个<code>kube-controller</code>和<code>kube-scheduler</code>节点来保证高可用</p>
<h2 id="worker节点请求数据通过多ip或负载均衡来保证"><a href="#worker节点请求数据通过多ip或负载均衡来保证" class="headerlink" title="worker节点请求数据通过多ip或负载均衡来保证"></a>worker节点请求数据通过多ip或负载均衡来保证</h2><p>节点请求通信通过多Ip或负载均衡来保证高可用，这里也有几种方式</p>
<h3 id="IaaS厂商可提供负载均衡的场景下"><a href="#IaaS厂商可提供负载均衡的场景下" class="headerlink" title="IaaS厂商可提供负载均衡的场景下"></a>IaaS厂商可提供负载均衡的场景下</h3><p>如下图所示，可将worker node的访问地址指向负载均衡的地址</p>
<p><img src="/Images/kubernetes-ha-iaas-lb.png" alt="kubernetes-ha-iaas-lb"></p>
<h3 id="私有化部署KeepAlived"><a href="#私有化部署KeepAlived" class="headerlink" title="私有化部署KeepAlived"></a>私有化部署KeepAlived</h3><p>私有化部署场景常用keepAlived提供浮动IP来给<code>worker node</code>或其他组件访问，如下图所示</p>
<p><img src="/Images/kubernetes-ha-keepalived.png" alt="kubernetes-ha-keepalived"></p>
<h3 id="私有化部署加上负载均衡组件"><a href="#私有化部署加上负载均衡组件" class="headerlink" title="私有化部署加上负载均衡组件"></a>私有化部署加上负载均衡组件</h3><p>如果你觉得同一时刻只有单个apiServer工作会成瓶颈，也可以使用<code>KeepAlived</code>加<code>Nginx</code>或<code>HaProxy</code>来对<code>ApiServer</code>做负载均衡</p>
<p><img src="/Images/kubernetes-ha-keepalived-nginx.png" alt="kubernetes-ha-keepalived-nginx"></p>
<p>为了简化图像，只画出了master1上的Nginx向后转发的场景。</p>
<p>至于Nginx和KeepAlived如何部署，推荐采用容器化的部署模式，方便进行监控和运维；但是镜像不从镜像仓库拉取，而是保存在<code>master</code>节点上，这样虽然升级复杂一点，但是这样子<code>kubernetes</code>的高可用就不依赖镜像仓库了，不会和镜像仓库形成循环依赖，更不会影响镜像仓库的高可用方案，大大简化了后续的技术方案。（因为镜像仓库可能会占据较大的存储空间，可能会和<code>master</code>节点分离部署，这时会作为<code>worker</code>节点连接<code>master</code>节点）。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hezhangjian.com/2021/08/20/GoFrame%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84Update%E9%9B%B6%E5%80%BC%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhangjian He">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张俭的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 张俭的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/20/GoFrame%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84Update%E9%9B%B6%E5%80%BC%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">GoFrame框架中的Update零值问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-20 20:16:14" itemprop="dateCreated datePublished" datetime="2021-08-20T20:16:14+08:00">2021-08-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-21 19:32:27" itemprop="dateModified" datetime="2025-10-21T19:32:27+08:00">2025-10-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>前几天，我的同事碰到了一个问题，是关于<strong>GoFrame</strong> 框架中数据字段的更新问题，数据中有一个<code>status</code>字段，他本来不想更新，但是却更新成了0。</p>
<p>相信看到描述，已经有经验丰富的专家可以猜到是数据部分更新导致的问题。</p>
<p>没错，就是因为数据库部分更新，把0这个值当成了需要更新的值刷新到了数据库中。</p>
<p>中间是复现问题的流程及代码细节，不感兴趣的可以直接拉到最后</p>
<h2 id="复现问题"><a href="#复现问题" class="headerlink" title="复现问题"></a>复现问题</h2><h3 id="创建一个数据表"><a href="#创建一个数据表" class="headerlink" title="创建一个数据表"></a>创建一个数据表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> health_check</span><br><span class="line">(</span><br><span class="line">    id           <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    str_null     <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NULL</span>,</span><br><span class="line">    str_not_null <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    int_null     <span class="type">INT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    int_not_null <span class="type">INT</span>         <span class="keyword">NOT NULL</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="插入一条数据"><a href="#插入一条数据" class="headerlink" title="插入一条数据"></a>插入一条数据</h3><p><img src="/Images/go-frame-update-zero1.png" alt="image-20210819104835758"></p>
<h3 id="数据库module的声明"><a href="#数据库module的声明" class="headerlink" title="数据库module的声明"></a>数据库module的声明</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> HealthCheck <span class="keyword">struct</span> &#123;</span><br><span class="line">	Id         <span class="type">string</span>  <span class="string">`orm:&quot;id&quot;`</span></span><br><span class="line">	StrNull    *<span class="type">string</span> <span class="string">`orm:&quot;str_null&quot;`</span></span><br><span class="line">	StrNotNull <span class="type">string</span>  <span class="string">`orm:&quot;str_not_null&quot;`</span></span><br><span class="line">	IntNull    *<span class="type">int</span>    <span class="string">`orm:&quot;int_null&quot;`</span></span><br><span class="line">	IntNotNull <span class="type">int</span>     <span class="string">`orm:&quot;int_not_null&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h3><p>这时，只想把IntNotNull字段更新成0</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UpdateHealth</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	table := g.DB().Schema(healthDb).Table(healthTable)</span><br><span class="line">	healthCheck := &amp;module.HealthCheck&#123;&#125;</span><br><span class="line">	healthCheck.Id = config.HealthCheckId</span><br><span class="line">	i := <span class="number">6</span></span><br><span class="line">	healthCheck.IntNull = &amp;i</span><br><span class="line">	table.Data(healthCheck).Where(<span class="string">&quot;id&quot;</span>, config.HealthCheckId)</span><br><span class="line">	result, err := table.Update()</span><br><span class="line">	glog.Info(result)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行完毕之后"><a href="#执行完毕之后" class="headerlink" title="执行完毕之后"></a>执行完毕之后</h3><p>除了我要更新的<code>int_not_null</code>字段，其他值都被修改了</p>
<p><img src="/Images/go-frame-update-zero2.png" alt="image-20210819111903460"></p>
<p>这肯定不是我们想要的效果，我们只想更新一个字段。</p>
<p>这个时候GoFrame框架提供了<code>OmitEmpty</code>方法，可以忽略0值，也就是达到没传值不修改的效果，让我们加上<code>OmitEmpty</code>试试</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">table := g.DB().Schema(healthDb).Table(healthTable).OmitEmpty()</span><br><span class="line">	healthCheck := &amp;module.HealthCheck&#123;&#125;</span><br><span class="line">	healthCheck.Id = config.HealthCheckId</span><br><span class="line">	i := <span class="number">0</span></span><br><span class="line">	healthCheck.IntNotNull = i</span><br><span class="line">	table.Data(healthCheck).Where(<span class="string">&quot;id&quot;</span>, config.HealthCheckId)</span><br><span class="line">	result, err := table.Update()</span><br><span class="line">	glog.Info(result)</span><br><span class="line">	<span class="keyword">return</span> err</span><br></pre></td></tr></table></figure>

<p>重新导入数据</p>
<p><img src="/Images/go-frame-update-zero3.png" alt="image-20210819110235646"></p>
<p>操作update</p>
<p><img src="/Images/go-frame-update-zero4.png" alt="image-20210819111954946"></p>
<p>可是什么都没有更新，原来OmitEmpty把数字0当做是0值，没有进行更新，那么要怎么写呢，答案是使用<code>*int</code>类型</p>
<p>让我们使用定位为<code>*int</code>类型的字段来更新一下<code>int_not_null</code>，代码如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UpdateHealth</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	table := g.DB().Schema(healthDb).Table(healthTable).OmitEmpty()</span><br><span class="line">	healthCheck := &amp;module.HealthCheck&#123;&#125;</span><br><span class="line">	healthCheck.Id = config.HealthCheckId</span><br><span class="line">	i := <span class="number">0</span></span><br><span class="line">	healthCheck.IntNull = &amp;i</span><br><span class="line">	table.Data(healthCheck).Where(<span class="string">&quot;id&quot;</span>, config.HealthCheckId)</span><br><span class="line">	result, err := table.Update()</span><br><span class="line">	glog.Info(result)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次操作Update</p>
<p><img src="/Images/go-frame-update-zero5.png" alt="image-20210819112254854"></p>
<p>效果达成.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>GoFrame的框架默认会对全量字段进行更新，无论你的字段有没有复制</li>
<li>OmitEmpty可以让框架跳过空值，但是int类型的0，也会跳过</li>
<li>如果你还是想用<code>OmitEmpty</code>跳过空值的情况下，写入0，请使用<code>*int</code>类型</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Zhangjian He</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
